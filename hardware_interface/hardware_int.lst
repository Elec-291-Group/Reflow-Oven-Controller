0000              1   ;----------------------------------------------------------------;
0000              2   ; UI_FINAL_UNITS.ASM                                             ;
0000              3   ;----------------------------------------------------------------;
                  5   $LIST
0000              7   
0000              8   org 0000H
0000 02010F       9       ljmp main
0003             10   
0003             11   ; ----------------------------------------------------------------
0003             12   ; 1. PIN DEFINITIONS
0003             13   ; ----------------------------------------------------------------
0003             14   ELCD_RS equ P1.7 ; Pin 18
0003             15   ELCD_E  equ P1.1 ; Pin 10
0003             16   ELCD_D4 equ P0.7 ; Pin 8
0003             17   ELCD_D5 equ P0.5 ; Pin 6
0003             18   ELCD_D6 equ P0.3 ; Pin 4
0003             19   ELCD_D7 equ P0.1 ; Pin 2
0003             20   
0003             21   BTN_SOAK_TEMP equ P0.0 ; Pin 1
0003             22   BTN_SOAK_TIME equ P0.2 ; Pin 3
0003             23   BTN_REFL_TEMP equ P0.4 ; Pin 5
0003             24   BTN_REFL_TIME equ P0.6 ; Pin 7
0003             25   
0003             26   ROW1 equ P1.2 ; Pin 13
0003             27   ROW2 equ P1.4 ; Pin 15
0003             28   ROW3 equ P1.6 ; Pin 17
0003             29   ROW4 equ P2.0 ; Pin 19
0003             30   COL1 equ P2.2 ; Pin 21
0003             31   COL2 equ P2.4 ; Pin 23
0003             32   COL3 equ P2.6 ; Pin 25
0003             33   COL4 equ P3.0 ; Pin 27
0003             34   
0003             35   ; ----------------------------------------------------------------
0003             36   ; 2. VARIABLES & STORAGE
0003             37   ; ----------------------------------------------------------------
0030             38   dseg at 0x30
0030             39   Current_State: ds 1   ; 0=Home, 1..4=Modes
0031             40   Cursor_Idx:    ds 1   ; Tracks cursor position
0032             41   
0032             42   ; --- BUFFER STORAGE ---
0032             43   ; Temp: 3 Digits + 'C' + Null = 5 bytes
0032             44   Buf_Soak_Temp: ds 5   
0037             45   ; Time: "00:00" + 's' + Null = 7 bytes
0037             46   Buf_Soak_Time: ds 7   
003E             47   Buf_Refl_Temp: ds 5   
0043             48   Buf_Refl_Time: ds 7   
004A             49   
0003             50   cseg
0003             51   ; --- STRINGS ---
0003 53656C65    52   Txt_Home:     db 'Select Mode:    ', 0
     6374204D
     6F64653A
     20202020
     00
0014 53657420    53   Txt_SoakT:    db 'Set Soak Temp   ', 0
     536F616B
     2054656D
     70202020
     00
0025 53657420    54   Txt_SoakTime: db 'Set Soak Time   ', 0
     536F616B
     2054696D
     65202020
     00
0036 53657420    55   Txt_ReflT:    db 'Set Reflow Temp ', 0
     5265666C
     6F772054
     656D7020
     00
0047 53657420    56   Txt_ReflTime: db 'Set Reflow Time ', 0
     5265666C
     6F772054
     696D6520
     00
0058             57   
                 -1   $include(LCD_4bit_DE10Lite_no_RW.inc)
0058              1   ;  LCD routines adapted for the DE10-Lite configured as a CV_8052 processor
0058              2   cseg
0058              3   
0058              4   ; When using a 33.333333MHz crystal clock
0058              5   ; one cycle takes 1.0/33.333333MHz = 30 ns
0058              6   
0058              7   ;---------------------------------;
0058              8   ; Wait 40 microseconds            ;
0058              9   ;---------------------------------;
0058             10   Wait40uSec:
0058 C000        11            push AR0
005A 78BE        12            mov R0, #190
005C             13   L0: 
005C 00          14            nop
005D 00          15            nop
005E 00          16            nop
005F 00          17            nop
0060 D8FA        18            djnz R0, L0 ; 1+1+1+1+3 cycles->7*30ns*190=40us
0062 D000        19            pop AR0
0064 22          20       ret
0065             21   
0065             22   ;---------------------------------;
0065             23   ; Wait 'R2' milliseconds          ;
0065             24   ;---------------------------------;
                 25   Wait_Milli_Seconds mac
                 26   	push AR2
                 27   	mov R2, %0
                 28   	lcall ?Wait_Milli_Seconds
                 29   	pop AR2
                 30   endmac
0065             31   
0065             32   ?Wait_Milli_Seconds:
0065 C000        33            push AR0
0067 C001        34            push AR1
0069 7932        35   L3: mov R1, #50
006B 78DF        36   L2: mov R0, #223
006D D8FE        37   L1: djnz R0, L1 ; 3 cycles->3*30ns*250=20.07us
006F D9FA        38       djnz R1, L2 ; 20.07us*50=1.004ms
0071 DAF6        39       djnz R2, L3 ; number of millisecons to wait passed in R2
0073 D001        40       pop AR1
0075 D000        41       pop AR0
0077 22          42       ret
0078             43            
0078             44   ;---------------------------------;
0078             45   ; Toggles the 'E' pin in the LCD  ;
0078             46   ;---------------------------------;
0078             47   ELCD_pulse:
0078 D291        48            setb ELCD_E
007A 120058      49            lcall Wait40uSec
007D C291        50            clr ELCD_E
007F 120058      51       lcall Wait40uSec ; This line is needed in the DE1SoC running an 8051 because it is much faster than the AT89LP51RC2
0082 22          52       ret
0083             53   
0083             54   ;---------------------------------;
0083             55   ; Writes acc to LCD in 4-bit mode ;
0083             56   ;---------------------------------;
0083             57   ELCD_byte:
0083             58            ; Write high 4 bits first
0083 A2E7        59            mov c, ACC.7
0085 9281        60            mov ELCD_D7, c
0087 A2E6        61            mov c, ACC.6
0089 9283        62            mov ELCD_D6, c
008B A2E5        63            mov c, ACC.5
008D 9285        64            mov ELCD_D5, c
008F A2E4        65            mov c, ACC.4
0091 9287        66            mov ELCD_D4, c
0093 120078      67       lcall ELCD_pulse
0096             68            ; Write low 4 bits next
0096 A2E3        69            mov c, ACC.3
0098 9281        70            mov ELCD_D7, c
009A A2E2        71            mov c, ACC.2
009C 9283        72            mov ELCD_D6, c
009E A2E1        73            mov c, ACC.1
00A0 9285        74            mov ELCD_D5, c
00A2 A2E0        75            mov c, ACC.0
00A4 9287        76            mov ELCD_D4, c
00A6 120078      77       lcall ELCD_pulse
00A9 22          78            ret
00AA             79   
00AA             80   ;---------------------------------;
00AA             81   ; Write data to LCD               ;
00AA             82   ;---------------------------------;
                 83   WriteData mac
                 84   	mov a, %0
                 85   	lcall ?WriteData
                 86   endmac
00AA             87            
00AA             88   ?WriteData:
00AA D297        89            setb ELCD_RS
00AC 020083      90            ljmp ELCD_byte
00AF             91   
00AF             92   ;---------------------------------;
00AF             93   ; Write command to LCD            ;
00AF             94   ;---------------------------------;
                 95   WriteCommand mac
                 96   	mov a, %0
                 97   	lcall ?WriteCommand
                 98   endmac
00AF             99   
00AF            100   ?WriteCommand:
00AF C297       101            clr ELCD_RS
00B1 020083     102            ljmp ELCD_byte
00B4            103   
00B4            104   ;---------------------------------;
00B4            105   ; Configure LCD in 4-bit mode     ;
00B4            106   ;---------------------------------;
00B4            107   ELCD_4BIT:
00B4 C291       108            clr ELCD_E   ; Resting state of LCD's enable pin is zero
00B6            109            ;clr ELCD_RW  ; RW forced to zero
00B6            110            
00B6            111            ; After power on, let the LCD start up before initializing
00B6 C002       112            push AR2
00B8 7A28       112            mov R2, #40
00BA 120065     112            lcall ?Wait_Milli_Seconds
00BD D002       112            pop AR2
00BF            113            
00BF            114            ; First make sure the LCD is in 8-bit mode and then change to 4-bit mode
00BF 7433       115            mov a, #0x33
00C1 1200AF     115            lcall ?WriteCommand
00C4 7433       116            mov a, #0x33
00C6 1200AF     116            lcall ?WriteCommand
00C9 7432       117            mov a, #0x32
00CB 1200AF     117            lcall ?WriteCommand ; change to 4-bit mode
00CE            118   
00CE            119            ; Configure the LCD
00CE 7428       120            mov a, #0x28
00D0 1200AF     120            lcall ?WriteCommand
00D3 740C       121            mov a, #0x0c
00D5 1200AF     121            lcall ?WriteCommand
00D8 7401       122            mov a, #0x01
00DA 1200AF     122            lcall ?WriteCommand ;  Clear screen command (takes some time)
00DD            123   
00DD            124       ;Wait for the clear screen command to finish.
00DD C002       125            push AR2
00DF 7A02       125            mov R2, #2
00E1 120065     125            lcall ?Wait_Milli_Seconds
00E4 D002       125            pop AR2
00E6 22         126       ret
00E7            127   
00E7            128   ;---------------------------------;
00E7            129   ; Send a constant string to LCD   ;
00E7            130   ;---------------------------------;
                131   Send_Constant_String mac
                132   	push dph
                133   	push dpl
                134   	push acc
                135   	mov dptr, %0
                136   	lcall ?Send_Constant_String
                137   	pop acc
                138   	pop dpl
                139   	pop dph
                140   endmac
00E7            141   
00E7            142   ?Send_Constant_String:
00E7 E4         143       clr a
00E8 93         144       movc a, @a+dptr
00E9 6006       145       jz ?Send_Constant_String_Done
00EB 1200AA     146       lcall ?WriteData
00EE A3         147       inc dptr
00EF 80F6       148       sjmp ?Send_Constant_String
00F1            149   ?Send_Constant_String_Done:
00F1 22         150       ret  
00F2            151   
00F2            152   ;---------------------------------;
00F2            153   ; Set LCD cursor at row, column   ;
00F2            154   ;---------------------------------;
                155   Set_Cursor mac
                156   	push acc
                157   	mov a, #%1
                158   	dec a
                159   	lcall ?Set_Cursor_%0 ; Select column and row
                160   	pop acc
                161   endmac
00F2            162   
00F2            163   ?Set_Cursor_2:
00F2 4440       164            orl a, #01000000B
00F4            165   ?Set_Cursor_1:
00F4 4480       166            orl a, #10000000B
00F6 0200AF     167            ljmp ?WriteCommand ; Select column and row
00F9            168   
00F9            169   ;---------------------------------;
00F9            170   ; Display a BCD number in the LCD ;
00F9            171   ;---------------------------------;
                172   Display_BCD mac
                173   	push ar0
                174   	mov r0, %0
                175   	lcall ?Display_BCD
                176   	pop ar0
                177   endmac
00F9            178   
00F9            179   ?Display_BCD:
00F9 C0E0       180            push acc
00FB            181            ; Write most significant digit
00FB E8         182            mov a, r0
00FC C4         183            swap a
00FD 540F       184            anl a, #0fh
00FF 4430       185            orl a, #30h
0101 1200AA     186            lcall ?WriteData
0104            187            ; write least significant digit
0104 E8         188            mov a, r0
0105 540F       189            anl a, #0fh
0107 4430       190            orl a, #30h
0109 1200AA     191            lcall ?WriteData
010C D0E0       192            pop acc
010E 22         193            ret
010F            194   
010F            195   ;------------------------------------;
010F            196   ; Display a char in the LCD          ;
010F            197   ;------------------------------------;
                198   Display_char mac
                199   	push acc
                200   	mov a, %0
                201   	lcall ?WriteData
                202   	pop acc
                203   endmac
010F            204   
010F             59            
010F             60   ; ----------------------------------------------------------------
010F             61   ; 3. MAIN PROGRAM
010F             62   ; ----------------------------------------------------------------
010F             63   main:
010F 75817F      64       mov SP, #0x7F
0112             65       
0112             66       ; --- PORT CONFIG ---
0112 759AAA      67       mov P0MOD, #0xAA 
0115 759BD6      68       mov P1MOD, #0xD6
0118 759C01      69       mov P2MOD, #0x01
011B 759D00      70       mov P3MOD, #0x00
011E             71   
011E             72       ; --- INIT LCD ---
011E 1200B4      73       lcall ELCD_4BIT
0121 740F        74       mov A, #0x0F ; Blink ON
0123 1200AF      75       lcall ?WriteCommand
0126             76   
0126             77       ; --- INITIALIZE BUFFERS ---
0126 12014A      78       lcall Init_All_Buffers
0129             79   
0129             80       ; --- STARTUP ---
0129 753000      81       mov Current_State, #0
012C 120267      82       lcall Update_Screen_Full
012F             83       
012F             84       ; Dummy Hex
012F 759146      85       mov HEX0, #0x46 
0132 759292      86       mov HEX1, #0x92 
0135 7593A4      87       mov HEX2, #0xA4 
0138 7594FF      88       mov HEX3, #0xFF
013B 758EFF      89       mov HEX4, #0xFF
013E 758FFF      90       mov HEX5, #0xFF
0141             91   
0141             92   Forever:
0141 120182      93       lcall Check_Buttons
0144 1201CB      94       lcall Check_Keypad
0147 020141      95       ljmp Forever
014A             96   
014A             97   ; ----------------------------------------------------------------
014A             98   ; 4. INITIALIZATION ROUTINES (UPDATED FOR UNITS)
014A             99   ; ----------------------------------------------------------------
014A            100   Init_All_Buffers:
014A            101       ; Init Temps to "C" (Shifting Style)
014A 7832       102       mov R0, #Buf_Soak_Temp
014C 12015B     103       lcall Load_Temp_Init
014F 783E       104       mov R0, #Buf_Refl_Temp
0151 12015B     105       lcall Load_Temp_Init
0154            106   
0154            107       ; Init Times to "00:00s" (Fixed Style)
0154 120161     108       lcall Reset_Soak_Time
0157 120167     109       lcall Reset_Refl_Time
015A 22         110       ret
015B            111   
015B            112   Load_Temp_Init:
015B            113       ; Starts with just "C"
015B 7643       114       mov @R0, #'C'
015D 08         115       inc R0
015E 7600       116       mov @R0, #0 ; Null
0160 22         117       ret
0161            118   
0161            119   Reset_Soak_Time:
0161 7837       120       mov R0, #Buf_Soak_Time
0163 12016D     121       lcall Load_Time_Template
0166 22         122       ret
0167            123   
0167            124   Reset_Refl_Time:
0167 7843       125       mov R0, #Buf_Refl_Time
0169 12016D     126       lcall Load_Time_Template
016C 22         127       ret
016D            128   
016D            129   Load_Time_Template:
016D            130       ; Loads "00:00s" + Null
016D 7630       131       mov @R0, #'0'
016F 08         132       inc R0
0170 7630       133       mov @R0, #'0'
0172 08         134       inc R0
0173 763A       135       mov @R0, #':'
0175 08         136       inc R0
0176 7630       137       mov @R0, #'0'
0178 08         138       inc R0
0179 7630       139       mov @R0, #'0'
017B 08         140       inc R0
017C 7673       141       mov @R0, #'s' ; UNIT ADDED HERE
017E 08         142       inc R0
017F 7600       143       mov @R0, #0
0181 22         144       ret
0182            145   
0182            146   ; ----------------------------------------------------------------
0182            147   ; 5. BUTTON HANDLER
0182            148   ; ----------------------------------------------------------------
0182            149   Check_Buttons:
0182 30800A     150       jnb BTN_SOAK_TEMP, Btn1_Press
0185 308212     151       jnb BTN_SOAK_TIME, Btn2_Press
0188 30841A     152       jnb BTN_REFL_TEMP, Btn3_Press
018B 308622     153       jnb BTN_REFL_TIME, Btn4_Press
018E 22         154       ret
018F            155   
018F            156   Btn1_Press:
018F 1203D2     157       lcall Wait25ms
0192 753001     158       mov Current_State, #1
0195 753100     159       mov Cursor_Idx, #0 
0198 8021       160       sjmp Redraw
019A            161   Btn2_Press:
019A 1203D2     162       lcall Wait25ms
019D 753002     163       mov Current_State, #2
01A0 753100     164       mov Cursor_Idx, #0
01A3 8016       165       sjmp Redraw
01A5            166   Btn3_Press:
01A5 1203D2     167       lcall Wait25ms
01A8 753003     168       mov Current_State, #3
01AB 753100     169       mov Cursor_Idx, #0
01AE 800B       170       sjmp Redraw
01B0            171   Btn4_Press:
01B0 1203D2     172       lcall Wait25ms
01B3 753004     173       mov Current_State, #4
01B6 753100     174       mov Cursor_Idx, #0
01B9 8000       175       sjmp Redraw
01BB            176   
01BB            177   Redraw:
01BB 120267     178       lcall Update_Screen_Full
01BE 3080FD     179       jnb BTN_SOAK_TEMP, $
01C1 3082FD     180       jnb BTN_SOAK_TIME, $
01C4 3084FD     181       jnb BTN_REFL_TEMP, $
01C7 3086FD     182       jnb BTN_REFL_TIME, $
01CA 22         183       ret
01CB            184   
01CB            185   ; ----------------------------------------------------------------
01CB            186   ; 6. KEYPAD HANDLER (SHIFTING UNIT LOGIC)
01CB            187   ; ----------------------------------------------------------------
01CB            188   Check_Keypad:
01CB E530       189       mov A, Current_State
01CD 6061       190       jz Keypad_Exit 
01CF 120311     191       lcall Keypad_Scan
01D2 505C       192       jnc Keypad_Exit
01D4            193   
01D4            194       ; --- CHECK STAR (*) -> RESET ---
01D4 EF         195       mov A, R7
01D5 B40E0A     196       cjne A, #14, Check_Hash
01D8 120248     197       lcall Reset_Current_Buffer
01DB 120267     198       lcall Update_Screen_Full 
01DE 753100     199       mov Cursor_Idx, #0 
01E1 22         200       ret
01E2            201   
01E2            202       ; --- CHECK HASH (#) -> IGNORE ---
01E2            203   Check_Hash:
01E2 EF         204       mov A, R7
01E3 B40C01     205       cjne A, #12, Check_Number
01E6 22         206       ret 
01E7            207   
01E7            208   Check_Number:
01E7 EF         209       mov A, R7
01E8 C3         210       clr C
01E9 940A       211       subb A, #10
01EB 5042       212       jnc Symbol_Key 
01ED            213       
01ED EF         214       mov A, R7
01EE 2430       215       add A, #0x30 ; ASCII
01F0 FD         216       mov R5, A 
01F1            217   
01F1            218       ; --- WRITE DIGIT ---
01F1 120231     219       lcall Get_Current_Buffer_Addr 
01F4 E531       220       mov A, Cursor_Idx
01F6 28         221       add A, R0
01F7 F8         222       mov R0, A 
01F8            223       
01F8 ED         224       mov A, R5
01F9 F6         225       mov @R0, A ; Overwrite whatever is there (even the 'C')
01FA            226       
01FA            227       ; --- ADVANCE CURSOR ---
01FA 0531       228       inc Cursor_Idx
01FC            229       
01FC            230       ; --- LOGIC BRANCH ---
01FC E530       231       mov A, Current_State
01FE B40102     232       cjne A, #1, Check_T_Mode2
0201 8005       233       sjmp Handle_Temp_Shift
0203            234   Check_T_Mode2:
0203 B40311     235       cjne A, #3, Handle_Time_Skip
0206 8000       236       sjmp Handle_Temp_Shift
0208            237   
0208            238   Handle_Temp_Shift:
0208            239       ; === THE MAGNETIC C LOGIC ===
0208            240       ; We just wrote a digit. Now write 'C' at the NEW Cursor position.
0208            241       ; R0 currently points to where we just wrote.
0208 08         242       inc R0 ; Next slot
0209 7643       243       mov @R0, #'C'
020B 08         244       inc R0
020C 7600       245       mov @R0, #0 ; Terminate
020E            246       
020E            247       ; Limit Check: If we hit 3 digits, back up so we don't go off screen
020E E531       248       mov A, Cursor_Idx
0210 B40318     249       cjne A, #3, Do_Refresh
0213 1531       250       dec Cursor_Idx
0215 8014       251       sjmp Do_Refresh
0217            252   
0217            253   Handle_Time_Skip:
0217            254       ; Time Logic (00:00s)
0217            255       ; Skip Colon (Index 2)
0217 E531       256       mov A, Cursor_Idx
0219 B40204     257       cjne A, #2, Check_Limit_Time
021C 0531       258       inc Cursor_Idx 
021E 8009       259       sjmp Normal_Time_Update
0220            260   
0220            261   Check_Limit_Time:
0220            262       ; Stop at 5 (don't overwrite 's' at index 5)
0220 E531       263       mov A, Cursor_Idx
0222 B40504     264       cjne A, #5, Normal_Time_Update
0225 1531       265       dec Cursor_Idx 
0227 8002       266       sjmp Do_Refresh
0229            267   
0229            268   Normal_Time_Update:
0229 8000       269       sjmp Do_Refresh
022B            270   
022B            271   Do_Refresh:
022B 120267     272       lcall Update_Screen_Full
022E 22         273       ret
022F            274   
022F            275   Symbol_Key:
022F 22         276       ret
0230            277   Keypad_Exit:
0230 22         278       ret
0231            279   
0231            280   ; ----------------------------------------------------------------
0231            281   ; 7. BUFFER UTILITIES
0231            282   ; ----------------------------------------------------------------
0231            283   Get_Current_Buffer_Addr:
0231 E530       284       mov A, Current_State
0233 B40103     285       cjne A, #1, G_M2
0236 7832       286       mov R0, #Buf_Soak_Temp
0238 22         287       ret
0239            288   G_M2:
0239 B40203     289       cjne A, #2, G_M3
023C 7837       290       mov R0, #Buf_Soak_Time
023E 22         291       ret
023F            292   G_M3:
023F B40303     293       cjne A, #3, G_M4
0242 783E       294       mov R0, #Buf_Refl_Temp
0244 22         295       ret
0245            296   G_M4:
0245 7843       297       mov R0, #Buf_Refl_Time
0247 22         298       ret
0248            299   
0248            300   Reset_Current_Buffer:
0248 E530       301       mov A, Current_State
024A B40106     302       cjne A, #1, R_M2
024D            303       ; Reset Temp 1 (Init to 'C')
024D 7832       304       mov R0, #Buf_Soak_Temp
024F 12015B     305       lcall Load_Temp_Init
0252 22         306       ret
0253            307   R_M2:
0253 B40204     308       cjne A, #2, R_M3
0256 120161     309       lcall Reset_Soak_Time
0259 22         310       ret
025A            311   R_M3:
025A B40306     312       cjne A, #3, R_M4
025D            313       ; Reset Temp 2 (Init to 'C')
025D 783E       314       mov R0, #Buf_Refl_Temp
025F 12015B     315       lcall Load_Temp_Init
0262 22         316       ret
0263            317   R_M4:
0263 120167     318       lcall Reset_Refl_Time
0266 22         319       ret
0267            320   
0267            321   ; ----------------------------------------------------------------
0267            322   ; 8. SCREEN UTILITIES
0267            323   ; ----------------------------------------------------------------
0267            324   Update_Screen_Full:
0267 120301     325       lcall Clear_Screen_Func 
026A            326       
026A            327       ; Line 1
026A C0E0       328            push acc
026C 7401       328            mov a, #1
026E 14         328            dec a
026F 1200F4     328            lcall ?Set_Cursor_1 ; Select column and row
0272 D0E0       328            pop acc
0274 E530       329       mov A, Current_State
0276 B40013     330       cjne A, #0, U_S1
0279 C083       331            push dph
027B C082       331            push dpl
027D C0E0       331            push acc
027F 900003     331            mov dptr, #Txt_Home
0282 1200E7     331            lcall ?Send_Constant_String
0285 D0E0       331            pop acc
0287 D082       331            pop dpl
0289 D083       331            pop dph
028B 22         332       ret 
028C            333   U_S1:
028C B40114     334       cjne A, #1, U_S2
028F C083       335            push dph
0291 C082       335            push dpl
0293 C0E0       335            push acc
0295 900014     335            mov dptr, #Txt_SoakT
0298 1200E7     335            lcall ?Send_Constant_String
029B D0E0       335            pop acc
029D D082       335            pop dpl
029F D083       335            pop dph
02A1 8040       336       sjmp Draw_Buffer
02A3            337   U_S2:
02A3 B40214     338       cjne A, #2, U_S3
02A6 C083       339            push dph
02A8 C082       339            push dpl
02AA C0E0       339            push acc
02AC 900025     339            mov dptr, #Txt_SoakTime
02AF 1200E7     339            lcall ?Send_Constant_String
02B2 D0E0       339            pop acc
02B4 D082       339            pop dpl
02B6 D083       339            pop dph
02B8 8029       340       sjmp Draw_Buffer
02BA            341   U_S3:
02BA B40314     342       cjne A, #3, U_S4
02BD C083       343            push dph
02BF C082       343            push dpl
02C1 C0E0       343            push acc
02C3 900036     343            mov dptr, #Txt_ReflT
02C6 1200E7     343            lcall ?Send_Constant_String
02C9 D0E0       343            pop acc
02CB D082       343            pop dpl
02CD D083       343            pop dph
02CF 8012       344       sjmp Draw_Buffer
02D1            345   U_S4:
02D1 C083       346            push dph
02D3 C082       346            push dpl
02D5 C0E0       346            push acc
02D7 900047     346            mov dptr, #Txt_ReflTime
02DA 1200E7     346            lcall ?Send_Constant_String
02DD D0E0       346            pop acc
02DF D082       346            pop dpl
02E1 D083       346            pop dph
02E3            347   
02E3            348   Draw_Buffer:
02E3            349       ; Line 2
02E3 C0E0       350            push acc
02E5 7401       350            mov a, #1
02E7 14         350            dec a
02E8 1200F2     350            lcall ?Set_Cursor_2 ; Select column and row
02EB D0E0       350            pop acc
02ED 120231     351       lcall Get_Current_Buffer_Addr 
02F0            352       
02F0            353   Print_RAM_Loop:
02F0 E6         354       mov A, @R0
02F1 6006       355       jz Print_Done 
02F3 1200AA     356       lcall ?WriteData
02F6 08         357       inc R0
02F7 80F7       358       sjmp Print_RAM_Loop
02F9            359   Print_Done:
02F9            360   
02F9            361       ; Restore Cursor
02F9 E531       362       mov A, Cursor_Idx
02FB 24C0       363       add A, #0xC0
02FD 1200AF     364       lcall ?WriteCommand
0300 22         365       ret
0301            366   
0301            367   Clear_Screen_Func:
0301 7401       368       mov A, #0x01 
0303 1200AF     369       lcall ?WriteCommand
0306 7A0A       370       mov R2, #10
0308 1203D2     371       lcall Wait25ms
030B 740F       372       mov A, #0x0F 
030D 1200AF     373       lcall ?WriteCommand
0310 22         374       ret
0311            375   
0311            376   ; ----------------------------------------------------------------
0311            377   ; 9. HARDWARE SCANNERS
0311            378   ; ----------------------------------------------------------------
0311            379   Keypad_Scan:
0311 C292       380       clr ROW1
0313 C294       381       clr ROW2
0315 C296       382       clr ROW3
0317 C2A0       383       clr ROW4
0319 A2A2       384       mov C, COL1
031B 82A4       385       anl C, COL2
031D 82A6       386       anl C, COL3
031F 82B0       387       anl C, COL4
0321 5002       388       jnc Keypad_Debounce 
0323 C3         389       clr C 
0324 22         390       ret
0325            391   Keypad_Debounce:
0325 1203D2     392       lcall Wait25ms
0328 A2A2       393       mov C, COL1
032A 82A4       394       anl C, COL2
032C 82A6       395       anl C, COL3
032E 82B0       396       anl C, COL4
0330 5002       397       jnc Keypad_Find_Row 
0332 C3         398       clr C
0333 22         399       ret
0334            400   Keypad_Find_Row:
0334 D292       401       setb ROW1
0336 D294       402       setb ROW2
0338 D296       403       setb ROW3
033A D2A0       404       setb ROW4
033C C292       405       clr ROW1
033E 30A23D     406       jnb COL1, K_1
0341 30A43E     407       jnb COL2, K_2
0344 30A63F     408       jnb COL3, K_3
0347 30B040     409       jnb COL4, K_A
034A D292       410       setb ROW1
034C C294       411       clr ROW2
034E 30A23D     412       jnb COL1, K_4
0351 30A43E     413       jnb COL2, K_5
0354 30A63F     414       jnb COL3, K_6
0357 30B040     415       jnb COL4, K_B
035A D294       416       setb ROW2
035C C296       417       clr ROW3
035E 30A23D     418       jnb COL1, K_7
0361 30A43E     419       jnb COL2, K_8
0364 30A63F     420       jnb COL3, K_9
0367 30B040     421       jnb COL4, K_C
036A D296       422       setb ROW3
036C C2A0       423       clr ROW4
036E 30A23D     424       jnb COL1, K_Star
0371 30A43E     425       jnb COL2, K_0
0374 30A63F     426       jnb COL3, K_Hash
0377 30B040     427       jnb COL4, K_D
037A D2A0       428       setb ROW4
037C C3         429       clr C 
037D 22         430       ret
037E            431   
037E 7F01       432   K_1: mov R7, #1
0380 803C       433        sjmp Wait_Rel
0382 7F02       434   K_2: mov R7, #2
0384 8038       435        sjmp Wait_Rel
0386 7F03       436   K_3: mov R7, #3
0388 8034       437        sjmp Wait_Rel
038A 7F0A       438   K_A: mov R7, #10
038C 8030       439        sjmp Wait_Rel
038E 7F04       440   K_4: mov R7, #4
0390 802C       441        sjmp Wait_Rel
0392 7F05       442   K_5: mov R7, #5
0394 8028       443        sjmp Wait_Rel
0396 7F06       444   K_6: mov R7, #6
0398 8024       445        sjmp Wait_Rel
039A 7F0B       446   K_B: mov R7, #11
039C 8020       447        sjmp Wait_Rel
039E 7F07       448   K_7: mov R7, #7
03A0 801C       449        sjmp Wait_Rel
03A2 7F08       450   K_8: mov R7, #8
03A4 8018       451        sjmp Wait_Rel
03A6 7F09       452   K_9: mov R7, #9
03A8 8014       453        sjmp Wait_Rel
03AA 7F0D       454   K_C: mov R7, #13
03AC 8010       455        sjmp Wait_Rel
03AE 7F0E       456   K_Star: mov R7, #14
03B0 800C       457        sjmp Wait_Rel
03B2 7F00       458   K_0: mov R7, #0
03B4 8008       459        sjmp Wait_Rel
03B6 7F0C       460   K_Hash: mov R7, #12
03B8 8004       461        sjmp Wait_Rel
03BA 7F0F       462   K_D: mov R7, #15
03BC 8000       463        sjmp Wait_Rel
03BE            464   
03BE            465   Wait_Rel:
03BE A2A2       466       mov C, COL1
03C0 82A4       467       anl C, COL2
03C2 82A6       468       anl C, COL3
03C4 82B0       469       anl C, COL4
03C6 50F6       470       jnc Wait_Rel 
03C8 D3         471       setb C 
03C9 D292       472       setb ROW1
03CB D294       473       setb ROW2
03CD D296       474       setb ROW3
03CF D2A0       475       setb ROW4
03D1 22         476       ret
03D2            477   
03D2            478   Wait25ms:
03D2 780F       479       mov R0, #15
03D4 794A       480   W_L3: mov R1, #74
03D6 7AFA       481   W_L2: mov R2, #250
03D8 DAFE       482   W_L1: djnz R2, W_L1 
03DA D9FA       483       djnz R1, W_L2 
03DC D8F6       484       djnz R0, W_L3 
03DE 22         485       ret
03DF            486   
03DF            487   EN
